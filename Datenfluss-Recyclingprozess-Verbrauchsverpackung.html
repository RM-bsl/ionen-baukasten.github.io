// --- Icons als lokale Komponenten (Inline SVGs) ---
const Factory = ({ size = 24, className = "" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z" />
    <path d="M17 18h1" />
    <path d="M12 18h1" />
    <path d="M7 18h1" />
  </svg>
);

const ShieldCheck = ({ size = 24, className = "" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
    <path d="m9 12 2 2 4-4" />
  </svg>
);

const Network = ({ size = 24, className = "" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <rect x="16" y="16" width="6" height="6" rx="1" />
    <rect x="2" y="16" width="6" height="6" rx="1" />
    <rect x="9" y="2" width="6" height="6" rx="1" />
    <path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3" />
    <path d="M12 12V8" />
  </svg>
);

const Scale = ({ size = 24, className = "" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" />
    <path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" />
    <path d="M7 21h10" />
    <path d="M12 3v18" />
    <path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" />
  </svg>
);

const CheckCircle2 = ({ size = 24, className = "" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <circle cx="12" cy="12" r="10" />
    <path d="m9 12 2 2 4-4" />
  </svg>
);

const AlertCircle = ({ size = 24, className = "" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <circle cx="12" cy="12" r="10" />
    <line x1="12" x2="12" y1="8" y2="12" />
    <line x1="12" x2="12.01" y1="16" y2="16" />
  </svg>
);

const HelpCircle = ({ size = 24, className = "" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <circle cx="12" cy="12" r="10" />
    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
    <path d="M12 17h.01" />
  </svg>
);

const ArrowRight = ({ size = 24, className = "" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <path d="M5 12h14" />
    <path d="m12 5 7 7-7 7" />
  </svg>
);

const Check = ({ size = 24, className = "" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <path d="M20 6 9 17l-5-5" />
  </svg>
);


// --- Hauptkomponente ---

const RecyclingFlowChart = () => {
  // State to track selected option ID for each station
  const [selections, setSelections] = useState({
    1: "default",
    2: "default",
    3: "default",
    4: "default"
  });

  // State to track if the OK button was clicked for each station
  const [validated, setValidated] = useState({
    1: false,
    2: false,
    3: false,
    4: false
  });

  // Data structure for the flow chart with didactic explanations
  const stations = [
    {
      id: 1,
      title: "1. Der Verwerter",
      subtitle: "Die Basis (Physisch)",
      icon: <Factory size={32} className="text-white" />,
      color: "bg-emerald-500",
      borderColor: "border-emerald-500",
      lightColor: "bg-emerald-50",
      description: "Verwandelt Abfall in Rohstoff (z.B. Granulat).",
      question: "Welche Daten werden generiert?",
      options: [
        { 
          id: "default", 
          text: "Bitte wählen ...", 
          isCorrect: null, 
          explanation: "",
          details: null
        },
        { 
          id: "correct", 
          text: "Wiegescheine & Letztempfängerbescheinigung", 
          isCorrect: true, 
          explanation: "Nur Wiegescheine (Input/Output) belegen exakt, wie viel Material tatsächlich verarbeitet wurde.",
          details: {
            action: "Physisches Recycling",
            data: "Input/Output Wiegescheine",
            receiver: "An Garantiegeber"
          }
        },
        { 
          id: "wrong1", 
          text: "Rechnung an den Endverbraucher", 
          isCorrect: false, 
          explanation: "Die Kosten werden zwar letztlich auf den Verbraucher umgelegt, aber dieser Beleg entsteht nicht direkt beim Recyclingprozess in der Anlage.",
          details: {
            action: "Kaufmännische Abrechnung",
            data: "Privatrechnungen",
            receiver: "An Bürger"
          }
        },
        { 
          id: "wrong2", 
          text: "Nur Lieferscheine ohne Gewichtsangabe", 
          isCorrect: false, 
          explanation: "Lieferscheine sind wichtig für den Transport, aber für den gesetzlichen Mengenstromnachweis ist das exakte Gewicht des Outputs entscheidend.",
          details: {
            action: "Logistischer Transport",
            data: "Lieferscheine (Stückgut)",
            receiver: "An Spedition"
          }
        }
      ]
    },
    {
      id: 2,
      title: "2. Der Garantiegeber",
      subtitle: "Prüfer & Bündeler",
      icon: <ShieldCheck size={32} className="text-white" />,
      color: "bg-blue-500",
      borderColor: "border-blue-500",
      lightColor: "bg-blue-50",
      description: "Sammelt Daten aller Anlagen einer Fraktion.",
      question: "Was ist die Kernaufgabe?",
      options: [
        { 
          id: "default", 
          text: "Bitte wählen ...", 
          isCorrect: null, 
          explanation: "",
          details: null
        },
        { 
          id: "correct", 
          text: "Plausibilitätsprüfung & Jahresmeldung", 
          isCorrect: true, 
          explanation: "Er bündelt die Daten vieler Verwerter, prüft sie auf Logik und garantiert dem System die Korrektheit.",
          details: {
            action: "Datenbündelung & Garantie",
            data: "Monats-/Jahresmeldung",
            receiver: "An das DSD"
          }
        },
        { 
          id: "wrong1", 
          text: "Physische Sortierung des Mülls", 
          isCorrect: false, 
          explanation: "Dies ist die Aufgabe der Sortieranlagen, die *vor* dem Verwerter stehen. Der Garantiegeber kümmert sich um die administrative Garantie.",
          details: {
            action: "Manuelle/Maschinelle Trennung",
            data: "Sortierprotokolle",
            receiver: "An Verwerter"
          }
        },
        { 
          id: "wrong2", 
          text: "Verkauf der Lizenzrechte", 
          isCorrect: false, 
          explanation: "Die Lizenzierung ist das Kerngeschäft der Dualen Systeme (wie DSD) gegenüber den Herstellern, nicht die Aufgabe des Garantiegebers.",
          details: {
            action: "Rechtevergabe",
            data: "Lizenzverträge",
            receiver: "An Hersteller"
          }
        }
      ]
    },
    {
      id: 3,
      title: "3. Das DSD",
      subtitle: "Der Systembetreiber",
      icon: <Network size={32} className="text-white" />,
      color: "bg-orange-500",
      borderColor: "border-orange-500",
      lightColor: "bg-orange-50",
      description: "Führt alle Fraktionen zusammen.",
      question: "Was wird gegenübergestellt?",
      options: [
        { 
          id: "default", 
          text: "Bitte wählen ...", 
          isCorrect: null, 
          explanation: "",
          details: null
        },
        { 
          id: "wrong1", 
          text: "Verkaufsmengen vs. Lagerbestände", 
          isCorrect: false, 
          explanation: "Diese Daten sind für die interne Logistik der Hersteller relevant, aber das DSD benötigt einen Abgleich, der auf Lizenzen basiert.",
          details: {
            action: "Lagerhaltung",
            data: "Inventurlisten",
            receiver: "An Einkaufsabteilung"
          }
        },
        { 
          id: "correct", 
          text: "Lizenzmengen vs. Recyclingmengen", 
          isCorrect: true, 
          explanation: "Der Mengenstromnachweis vergleicht das 'Soll' (bezahlte Lizenzen) mit dem 'Ist' (recycelte Menge).",
          details: {
            action: "Erstellung Mengenstromnachweis",
            data: "Soll (Lizenz) vs. Ist (Recycling)",
            receiver: "An ZSVR / Behörde"
          }
        },
        { 
          id: "wrong2", 
          text: "Einnahmen vs. Ausgaben", 
          isCorrect: false, 
          explanation: "Dies ist die finanzielle Bilanz des DSD. Der Mengenstromnachweis ist jedoch eine ökologische Massenbilanz.",
          details: {
            action: "Finanzbuchhaltung",
            data: "Bilanz / GuV",
            receiver: "An Finanzamt"
          }
        }
      ]
    },
    {
      id: 4,
      title: "4. Der Abgleich (ZSVR)",
      subtitle: "Das Schließen des Kreises",
      icon: <Scale size={32} className="text-white" />,
      color: "bg-purple-600",
      borderColor: "border-purple-600",
      lightColor: "bg-purple-50",
      description: "Behördliche Endkontrolle.",
      question: "Was ist das Prüfziel?",
      options: [
        { 
          id: "default", 
          text: "Bitte wählen ...", 
          isCorrect: null, 
          explanation: "",
          details: null
        },
        { 
          id: "wrong1", 
          text: "Qualitätsprüfung des Granulats", 
          isCorrect: false, 
          explanation: "Die Qualität ist wichtig für den Markt, aber die Behörde prüft primär die Einhaltung der gesetzlichen *Mengen*-Quoten.",
          details: {
            action: "Materialprüfung",
            data: "Laboranalysen",
            receiver: "An Kunststoffverarbeiter"
          }
        },
        { 
          id: "wrong2", 
          text: "Prüfung der Müllgebühren", 
          isCorrect: false, 
          explanation: "Dies betrifft die kommunale Abfallwirtschaft. Die ZSVR prüft die nationale Umsetzung der Produktverantwortung durch die Hersteller.",
          details: {
            action: "Gebührenkalkulation",
            data: "Kommunale Kostensatzung",
            receiver: "An Gebührenzahler"
          }
        },
        { 
          id: "correct", 
          text: "Quoten (VerpackG) & LUCID-Abgleich", 
          isCorrect: true, 
          explanation: "Die Behörde prüft, ob die gesetzlichen Ziele erreicht wurden und deckt Trittbrettfahrer auf.",
          details: {
            action: "Finaler Registerabgleich",
            data: "LUCID-Daten vs. Nachweis",
            receiver: "Abschluss / Sanktion"
          }
        }
      ]
    }
  ];

  const handleSelect = (stationId, optionId) => {
    setSelections(prev => ({ ...prev, [stationId]: optionId }));
    // Reset validation when selection changes so user can try again or just read new explanation
    setValidated(prev => ({ ...prev, [stationId]: false }));
  };

  const handleValidate = (stationId) => {
    setValidated(prev => ({ ...prev, [stationId]: true }));
  };

  const getSelectionInfo = (stationId) => {
    const selectedOptionId = selections[stationId];
    const station = stations.find(s => s.id === stationId);
    
    if (selectedOptionId === "default") return { status: 'empty', explanation: null, isCorrect: null, details: null };
    
    const option = station.options.find(o => o.id === selectedOptionId);
    return {
      status: 'selected',
      explanation: option?.explanation,
      isCorrect: option?.isCorrect,
      details: option?.details
    };
  };

  return (
    <div className="w-full max-w-6xl mx-auto p-4 bg-gray-50 rounded-xl font-sans">
      <div className="mb-8 text-center">
        <h2 className="text-2xl font-bold text-gray-800 mb-2">Datenfluss im Recyclingprozess</h2>
        <p className="text-gray-600">Wählen Sie für jede Station die richtige Tätigkeit, lesen Sie die Erklärung und bestätigen Sie Ihre Wahl.</p>
      </div>

      {/* Flow Container - Horizontal Scroll on Mobile */}
      <div className="flex flex-col lg:flex-row justify-between items-start gap-4 lg:gap-0 overflow-x-auto pb-4 relative">
        
        {/* Connection Line (Desktop only) */}
        <div className="hidden lg:block absolute top-12 left-0 w-full h-1 bg-gray-200 -z-10 transform translate-y-4"></div>

        {stations.map((station, index) => {
          const { explanation, isCorrect, details } = getSelectionInfo(station.id);
          const isValidated = validated[station.id];
          
          // Determine Icon and Color state based on validation
          const headerStatus = isValidated && isCorrect ? 'correct' : 'neutral';

          return (
            <div key={station.id} className="flex flex-col items-center w-full lg:w-1/4 px-2 relative group">
              
              {/* Arrow for mobile (between items) */}
              {index < stations.length - 1 && (
                <div className="lg:hidden absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-gray-300 z-10">
                  <ArrowRight className="rotate-90" size={24} />
                </div>
              )}
              
              {/* Arrow for desktop (between items) */}
              {index < stations.length - 1 && (
                <div className="hidden lg:block absolute top-12 -right-4 text-gray-300 z-10">
                  <ArrowRight size={32} />
                </div>
              )}

              {/* Icon Header */}
              <div className={`w-16 h-16 rounded-full flex items-center justify-center shadow-lg mb-4 z-20 transition-all duration-300 ${headerStatus === 'correct' ? station.color : 'bg-gray-400'}`}>
                {headerStatus === 'correct' ? <CheckCircle2 size={32} className="text-white" /> : station.icon}
              </div>

              {/* Card */}
              <div className={`w-full bg-white rounded-lg shadow-md border-t-4 ${station.borderColor} p-4 flex flex-col min-h-[420px] transition-all duration-300 hover:shadow-xl`}>
                
                <div className="text-center mb-3">
                  <h3 className="font-bold text-gray-800">{station.title}</h3>
                  <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide">{station.subtitle}</span>
                </div>

                <div className={`text-sm text-gray-600 mb-4 p-2 rounded ${station.lightColor}`}>
                  {station.description}
                </div>

                <div className="mt-auto">
                  <label className="block text-xs font-bold text-gray-700 mb-1">
                    {station.question}
                  </label>
                  
                  {/* Dropdown - Always Neutral Styling */}
                  <select 
                    className="w-full p-2 text-sm border border-gray-300 rounded cursor-pointer transition-colors outline-none focus:ring-2 focus:ring-blue-200 bg-white text-gray-800"
                    onChange={(e) => handleSelect(station.id, e.target.value)}
                    value={selections[station.id]}
                  >
                    {station.options.map((opt) => (
                      <option key={opt.id} value={opt.id} disabled={opt.id === 'default'}>
                        {opt.text}
                      </option>
                    ))}
                  </select>

                  {/* Feedback Area */}
                  <div className="mt-3 min-h-[100px]">
                    {selections[station.id] !== "default" && (
                      <>
                        {/* Short Explanation Box */}
                        <div className={`text-xs p-3 rounded mb-2 transition-colors duration-300 flex items-start gap-2
                          ${!isValidated ? 'bg-slate-100 text-slate-700' : 
                            isCorrect ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'}
                        `}>
                          <div className="mt-0.5 flex-shrink-0">
                             {!isValidated && <HelpCircle size={16} className="text-slate-400" />}
                             {isValidated && isCorrect && <CheckCircle2 size={16} className="text-green-600" />}
                             {isValidated && !isCorrect && <AlertCircle size={16} className="text-red-600" />}
                          </div>
                          <span>{explanation}</span>
                        </div>

                         {/* Info Box (Now placed ABOVE the button) */}
                        <div className={`mt-2 mb-3 pt-2 border-t border-gray-100 text-xs transition-all duration-500 overflow-hidden 
                          ${details ? 'opacity-100 max-h-40' : 'opacity-0 max-h-0'}`}>
                          <div className="grid grid-cols-[auto_1fr] gap-x-2 gap-y-1">
                            <span className="font-semibold text-gray-500">Aktion:</span>
                            <span className="text-gray-800">{details?.action}</span>
                            
                            <span className="font-semibold text-gray-500">Daten:</span>
                            <span className="text-gray-800">{details?.data}</span>
                            
                            <span className="font-semibold text-gray-500">Ziel:</span>
                            <span className="text-gray-800 italic">{details?.receiver}</span>
                          </div>
                        </div>

                        {/* Validation Button or Result Message (Now at the bottom) */}
                        {!isValidated ? (
                          <button 
                            onClick={() => handleValidate(station.id)}
                            className="w-full py-2 bg-gray-800 hover:bg-black text-white text-sm font-semibold rounded shadow-md 
                                     transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2 group"
                          >
                            <span>OK</span>
                            <Check size={16} className="transition-transform group-hover:translate-x-1" />
                          </button>
                        ) : (
                          <div className={`text-center text-xs font-bold uppercase tracking-wider py-1
                            ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>
                            {isCorrect ? 'Richtig' : 'Falsch'}
                          </div>
                        )}
                      </>
                    )}
                    
                    {selections[station.id] === "default" && (
                       <div className="flex items-center justify-center gap-2 text-gray-400 p-4 text-xs italic">
                          <span>Bitte wählen Sie eine Option...</span>
                       </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* Summary Footer */}
      <div className="mt-8 p-4 bg-slate-100 rounded-lg text-center text-sm text-gray-600 border border-slate-200">
        <span className="font-semibold">Legende:</span> Der Datenfluss verläuft von der physischen Basis (Verwerter) über die Prüfung (Garantiegeber) zur Systemebene (DSD) bis hin zur staatlichen Kontrolle (ZSVR).
      </div>
    </div>
  );
};

export default RecyclingFlowChart;
